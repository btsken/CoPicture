<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>WebSocket Test</title>


</head>

<body>
    <div>
        <canvas id="myCanvas">
        </canvas>

        <img id="pic">
    </div>
    <h2>WebSocket Test</h2>
    <div>
        <input type="file" id="msg">
        <button id="send">send</button>
    </div>

    <div id="output"></div>
</body>

</html>
<script language="javascript" type="text/javascript">
var wsUri = "ws://localhost:8085";
var output;
var msg = document.getElementById("msg"),
    sendBtn = document.getElementById("send"),
    pic = document.getElementById("pic");



var mainCanvas = document.getElementById("myCanvas");
var mainContext = mainCanvas.getContext('2d');

var canvasWidth = mainCanvas.width;
var canvasHeight = mainCanvas.height;
var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

var circles = new Array();
var pictures = [];

function Circle(initialX, initialY, radius) {
    this.radius = radius;
    this.initialX = initialX;
    this.initialY = initialY;
}

Circle.prototype.update = function() {

    // The following code is responsible for actually drawing the circle on the screen
    mainContext.beginPath();
    mainContext.arc(this.initialX, this.initialY, this.radius, 0, 2 * Math.PI);
    mainContext.closePath();
    mainContext.fillStyle = 'rgba(177, 0, 129, 1)';
    mainContext.fill();
};


mainCanvas.addEventListener("mouseup", function(e) {
    var circle = new Circle(e.pageX, e.pageY, 10);
    // circle.update();
    circles.push(circle);

    doSend(JSON.stringify(new Command("circle", JSON.stringify(circles))));

}, false);

msg.addEventListener("change", function(e) {
    if (this.files && this.files[0]) {
        var FR = new FileReader();

        FR.onload = function(e) {
            console.log(e.target.result);
            pictures.push(e.target.result);
            doSend(JSON.stringify(new Command("picture", JSON.stringify(pictures))));
        };

        FR.readAsDataURL(this.files[0]);
    }

}, false);


init();

function init() {
    output = document.getElementById("output");
    testWebSocket();

    sendBtn.addEventListener("click", function(e) {
        doSend(msg.value);
    }, false);
}

function testWebSocket() {
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) {
        onOpen(evt)
    };

    websocket.onclose = function(evt) {
        onClose(evt)
    };

    websocket.onmessage = function(evt) {
        onMessage(evt)
    };

    websocket.onerror = function(evt) {
        onError(evt)
    };
}

function onOpen(evt) {
    writeToScreen("CONNECTED");
}

function onClose(evt) {
    writeToScreen("DISCONNECTED");
}

function onMessage(evt) {
    writeToScreen('<span style="color:blue;">RESPONSE:' + evt.data + '</span>');

    try {
        var object = JSON.parse(evt.data);

        switch (object.name) {
            case "circle":
                var obj = JSON.parse(object.object);

                mainContext.clearRect(0, 0, canvasWidth, canvasHeight);
                circles = new Array();
                for (var i = 0; i < obj.length; i++) {
                    var circle = new Circle(obj[i].initialX, obj[i].initialY, obj[i].radius);
                    circles.push(circle);
                    circle.update();
                }

                break;
            case "picture":
                var obj = JSON.parse(object.object);
                pictures = [];
                for (var i = 0; i < obj.length; i++) {

                    pictures.push(obj[i]);
                    pic.src = obj[i];
                }   

                break;
        }
    } catch (e) {

    }

}

function onError(evt) {
    writeToScreen('<span style="color:red;">ERROR:</span>' + evt.data);
}

function doSend(message) {
    writeToScreen("SENT: " + message);
    websocket.send(message);
}

function writeToScreen(message) {
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
}

function Command(name, object) {
    this.name = name;
    this.object = object;
}

Command.prototype.send = function() {
    ws.broadcast(JSON.stringify(this));
};
</script>
