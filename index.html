<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>WebSocket Test</title>

    <style type="text/css">
    div,
    section {
        border: 5px solid;
        border-radius: 4px;
    }
    .container {
        display: -webkit-flex;
        display: flex;
    }
    nav {
        width: 500px;
    }
    .flex-column {
        -webkit-flex: 1;
        flex: 1;
    }
    canvas {
        border: 1px solid red;
        display:block;
    }
    </style>

</head>

<body>
    <h1>PicCollage</h1>
    <div class="container">

        <div class="flex-column">

            <section style="height:700px">
                <canvas id="pictureLayer" height="700" width="1310" style="position: absolute; z-index: 1;"></canvas>
                <canvas id="drawLayer" height="700" width="1310" style="position: absolute; z-index: 2;"></canvas>
                <canvas id="stickerLayer" height="700" width="1310" style="position: absolute;  z-index: 3;"></canvas>
                <canvas id="textLayer" height="700" width="1310" style="position: absolute; z-index: 4;"></canvas>
            </section>

            <section>
                天布麼次，今親他利用或母電氣能真友老久來進登出總形：國大系思樂麼問做去將地樹作、維你我們，師為什那，會輕步省生一們些的間海學了；能大作以電回球地現廠美馬方，別到最刻親個神故靜西招國老北氣反大育發商告味必資始定可對謝度的！找謝對環的片他這下：母來感從還，叫我火教會經神送兒沒業是地場色是身收但進經道。媽兒們有先他怕雖發形的手最出在個是我不引最引現小企是而？一子很及女種走？他傳樣會當工視各過男二年傳，但式希叫裡上優經的友定你……不前空國會世解，也斯他不體裡一光車別？加去命最點著如推著人所間國作感我觀，可場是過入指待說，理求面輕美事福出過白到片不是的快究是漸片力男創北一落我成不，精能等動張色輪酒、吃理站毒上出一，黃時回趣吃然，意小童提，到苦際一出如遊軍現媽濟手喜……現結從過計不太聞經是她！變連事成通，中財陸呢十母裝有他成綠上童不個。
            </section>

        </div>
        <nav>
            天布麼次，今親他利用或母電氣能真友老久來進登出總形：國大系思樂麼問做去將地樹作、維你我們，師為什那，會輕步省生一們些的間海學了；能大作以電回球地現廠美馬方，別到最刻親個神故靜西招國老北氣反大育發商告味必資始定可對謝度的！找謝對環的片他這下：母來感從還，叫我火教會經神送兒沒業是地場色是身收但進經道。媽兒們有先他怕雖發形的手最出在個是我不引最引現小企是而？一子很及女種走？他傳樣會當工視各過男二年傳，但式希叫裡上優經的友定你……不前空國會世解，也斯他不體裡一光車別？加去命最點著如推著人所間國作感我觀，可場是過入指待說，理求面輕美事福出過白到片不是的快究是漸片力男創北一落我成不，精能等動張色輪酒、吃理站毒上出一，黃時回趣吃然，意小童提，到苦際一出如遊軍現媽濟手喜……現結從過計不太聞經是她！變連事成通，中財陸呢十母裝有他成綠上童不個。
        </nav>
    </div>








    <!-- 
    <div>
        <canvas id="myCanvas" height="600" width="800">
        </canvas>

        <img id="pic">
    </div>
    <h2>WebSocket Test</h2>
    <div>
        <input type="file" id="msg">
        <button id="send">send</button>
    </div>

    <div id="output"></div> -->
</body>

</html>
<script language="javascript" type="text/javascript">
var wsUri = "ws://localhost:8085";
var output;
var msg = document.getElementById("msg"),
    sendBtn = document.getElementById("send"),
    pic = document.getElementById("pic");



var mainCanvas = document.getElementById("pictureLayer");
var mainContext = mainCanvas.getContext('2d');

var canvasWidth = mainCanvas.width;
var canvasHeight = mainCanvas.height;
var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

var circles = new Array();
var pictures = [];




window.addEventListener('resize', resizeCanvas, false);
        
        function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                /**
                 * Your drawings need to be inside this function otherwise they will be reset when 
                 * you resize the browser window and the canvas goes will be cleared.
                 */
                drawStuff(); 
        }
        resizeCanvas();

function Circle(initialX, initialY, radius) {
    this.radius = radius;
    this.initialX = initialX;
    this.initialY = initialY;
}

Circle.prototype.update = function() {

    // The following code is responsible for actually drawing the circle on the screen
    mainContext.beginPath();
    mainContext.arc(this.initialX, this.initialY, this.radius, 0, 2 * Math.PI);
    mainContext.closePath();
    mainContext.fillStyle = 'rgba(177, 0, 129, 1)';
    mainContext.fill();
};


mainCanvas.addEventListener("mouseup", function(e) {
    var circle = new Circle(e.pageX, e.pageY, 10);
    // circle.update();
    circles.push(circle);

    doSend(JSON.stringify(new Command("circle", JSON.stringify(circles))));

}, false);

msg.addEventListener("change", function(e) {
    if (this.files && this.files[0]) {
        var FR = new FileReader();

        FR.onload = function(e) {
            console.log(e.target.result);
            pictures.push(e.target.result);
            doSend(JSON.stringify(new Command("picture", JSON.stringify(pictures))));
        };

        FR.readAsDataURL(this.files[0]);
    }

}, false);


function init() {
    output = document.getElementById("output");
    testWebSocket();

    sendBtn.addEventListener("click", function(e) {
        doSend(msg.value);
    }, false);
}

function testWebSocket() {
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) {
        onOpen(evt)
    };

    websocket.onclose = function(evt) {
        onClose(evt)
    };

    websocket.onmessage = function(evt) {
        onMessage(evt)
    };

    websocket.onerror = function(evt) {
        onError(evt)
    };
}

function onOpen(evt) {
    writeToScreen("CONNECTED");
}

function onClose(evt) {
    writeToScreen("DISCONNECTED");
}

function onMessage(evt) {
    writeToScreen('<span style="color:blue;">RESPONSE:' + evt.data + '</span>');

    try {
        var object = JSON.parse(evt.data);

        switch (object.name) {
            case "circle":
                var obj = JSON.parse(object.object);

                mainContext.clearRect(0, 0, canvasWidth, canvasHeight);
                circles = new Array();
                for (var i = 0; i < obj.length; i++) {
                    var circle = new Circle(obj[i].initialX, obj[i].initialY, obj[i].radius);
                    circles.push(circle);
                    circle.update();
                }

                break;
            case "picture":
                var obj = JSON.parse(object.object);
                pictures = [];
                for (var i = 0; i < obj.length; i++) {

                    pictures.push(obj[i]);
                    // pic.src = obj[i];
                    drawImg(obj[i]);
                }

                break;
        }
    } catch (e) {

    }

}

function drawImg(src) {
    var img = new Image();
    img.onload = function() {
        mainContext.drawImage(img, 0, 0);
    }
    img.src = src;
}

function onError(evt) {
    writeToScreen('<span style="color:red;">ERROR:</span>' + evt.data);
}

function doSend(message) {
    writeToScreen("SENT: " + message);
    websocket.send(message);
}

function writeToScreen(message) {
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
}

function Command(name, object) {
    this.name = name;
    this.object = object;
}

Command.prototype.send = function() {
    ws.broadcast(JSON.stringify(this));
};
</script>
