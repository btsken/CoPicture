<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>WebSocket Test</title>

    <style type="text/css">
    * {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }
    .area {
        border-top: 10px solid #d0f265;
    }
    .container {
        display: -webkit-flex;
        display: flex;
    }
    nav {
        border-left: 10px solid #d0f265;
        width: 500px;
    }
    .flex-column {
        -webkit-flex: 1;
        flex: 1;
    }
    canvas {
        /*border: 1px solid red;*/
        display: block;
        cursor: url(img/pen.png), auto;
        ;
    }
    .container {
        border: 10px solid #d0f265;
        border-radius: 10px;
    }
    </style>

</head>

<body>

    <h1>PicCollage</h1>
    <div class="container">

        <div class="flex-column">

            <section class="canvas">
                <canvas id="pictureLayer"></canvas>
                <!--             <canvas id="drawLayer" height="700" width="1310" style="position: absolute; z-index: 2;"></canvas>
                <canvas id="stickerLayer" height="700" width="1310" style="position: absolute;  z-index: 3;"></canvas>
                <canvas id="textLayer" height="700" width="1310" style="position: absolute; z-index: 4;"></canvas> -->
            </section>

            <section class="area">
                <input type="file" id="msg">
            </section>
        </div>
        <nav class="">

        </nav>
    </div>

</body>

</html>
<script language="javascript" type="text/javascript">
var wsUri = "ws://localhost:8085";
var msg = document.getElementById("msg"),
    sendBtn = document.getElementById("send");

var pictureLayer = document.getElementById("pictureLayer"),
    drawLayer = document.getElementById("drawLayer"),
    stickerLayer = document.getElementById("stickerLayer"),
    textLayer = document.getElementById("textLayer");

var mainContext = pictureLayer.getContext('2d');

var canvasWidth = pictureLayer.width;
var canvasHeight = pictureLayer.height;

var circles = new Array();
var pictures = [];

window.addEventListener('resize', resizeCanvas, false);

function resizeCanvas() {
    pictureLayer.width = window.innerWidth - 560;
    pictureLayer.height = window.innerHeight * 0.8;
    // drawLayer.width = window.innerWidth - 550;
    // stickerLayer.width = window.innerWidth - 550;
    // textLayer.width = window.innerWidth - 550;
}
resizeCanvas();
init();

function Circle(initialX, initialY, radius) {
    this.radius = radius;
    this.initialX = initialX;
    this.initialY = initialY;
}

Circle.prototype.update = function() {

    // The following code is responsible for actually drawing the circle on the screen
    mainContext.beginPath();
    mainContext.arc(this.initialX, this.initialY, this.radius, 0, 2 * Math.PI);
    mainContext.closePath();
    mainContext.fillStyle = 'rgba(177, 0, 129, 1)';
    mainContext.fill();
};


pictureLayer.addEventListener("mouseup", function(e) {
    var circle = new Circle(e.pageX - pictureLayer.offsetLeft + 15, e.pageY - pictureLayer.offsetTop + 40, 10);
    // circle.update();
    circles.push(circle);

    doSend(JSON.stringify(new Command("circle", JSON.stringify(circles))));

}, false);

msg.addEventListener("change", function(e) {
    if (this.files && this.files[0]) {
        var FR = new FileReader();

        FR.onload = function(e) {
            console.log(e.target.result);
            pictures.push(e.target.result);
            doSend(JSON.stringify(new Command("picture", JSON.stringify(pictures))));
        };

        FR.readAsDataURL(this.files[0]);
    }

}, false);


function init() {
    testWebSocket();
}

function testWebSocket() {
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) {
        onOpen(evt)
    };

    websocket.onclose = function(evt) {
        onClose(evt)
    };

    websocket.onmessage = function(evt) {
        onMessage(evt)
    };

    websocket.onerror = function(evt) {
        onError(evt)
    };
}

function onOpen(evt) {
    writeToScreen("CONNECTED");
}

function onClose(evt) {
    writeToScreen("DISCONNECTED");
}

function onMessage(evt) {
    writeToScreen('<span style="color:blue;">RESPONSE:' + evt.data + '</span>');

    try {
        var object = JSON.parse(evt.data);

        switch (object.name) {
            case "circle":
                var obj = JSON.parse(object.object);

                mainContext.clearRect(0, 0, canvasWidth, canvasHeight);
                circles = new Array();
                for (var i = 0; i < obj.length; i++) {
                    var circle = new Circle(obj[i].initialX, obj[i].initialY, obj[i].radius);
                    circles.push(circle);
                    circle.update();
                }

                break;
            case "picture":
                var obj = JSON.parse(object.object);
                pictures = [];
                for (var i = 0; i < obj.length; i++) {

                    pictures.push(obj[i]);
                    // pic.src = obj[i];
                    drawImg(obj[i]);
                }

                break;
        }
    } catch (e) {

    }

}

function drawImg(src) {
    var img = new Image();
    img.onload = function() {
        mainContext.drawImage(img, 0, 0);
    }
    img.src = src;
}

function onError(evt) {
    writeToScreen('<span style="color:red;">ERROR:</span>' + evt.data);
}

function doSend(message) {
    writeToScreen("SENT: " + message);
    websocket.send(message);
}

function writeToScreen(message) {
    // var pre = document.createElement("p");
    // pre.style.wordWrap = "break-word";
    // pre.innerHTML = message;
    // output.appendChild(pre);
}

function Command(name, object) {
    this.name = name;
    this.object = object;
}

Command.prototype.send = function() {
    ws.broadcast(JSON.stringify(this));
};
</script>
