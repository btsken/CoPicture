<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>WebSocket Test</title>
    <link rel="stylesheet" href="css/style.css">

</head>

<body>

    <h1>PicCollage</h1>
    <div class="container">

        <div class="flex-column">
            <section class="canvas" id="drawArea">
                <canvas id="pictureLayer" style="z-index:1;"></canvas>
                <canvas id="drawLayer" style="z-index:2;"></canvas>
                <canvas id="stickerLayer" style="z-index:3;"></canvas>
                <canvas id="textLayer" style="z-index:4;"></canvas>
                <canvas id="mouseLayer" style="z-index:5;"></canvas>
            </section>
            <section class="area">
                <button id="background"></button>
                <button id="paint"></button>
                <button id="sticker"></button>
                <button id="text"></button>
                <button id="download"></button>
                <div id='file_browse_wrapper'>
                    <input type='file' id='file_browse'>
                </div>
            </section>
        </div>
        <nav class="nav">

        </nav>
    </div>

</body>

</html>
<script type="text/javascript" src="js/oo.js"></script>
<script language="javascript" type="text/javascript">
var wsUri = "ws://localhost:8085";
var pictureLayer = document.getElementById("pictureLayer"),
    drawLayer = document.getElementById("drawLayer"),
    stickerLayer = document.getElementById("stickerLayer"),
    textLayer = document.getElementById("textLayer"),
    mouseLayer = document.getElementById("mouseLayer"),
    file_browse = document.getElementById("file_browse"),
    drawArea = document.getElementById("drawArea");

var pictureContext = pictureLayer.getContext('2d'),
    drawContext = drawLayer.getContext('2d'),
    stickerContext = stickerLayer.getContext('2d'),
    textContext = textLayer.getContext('2d'),
    mouseContext = mouseLayer.getContext('2d');

var canvasWidth = pictureLayer.width;
var canvasHeight = pictureLayer.height;

window.addEventListener('resize', resizeCanvas, false);

function resizeCanvas() {
    pictureLayer.width = window.innerWidth - 540;
    pictureLayer.height = window.innerHeight - 280;
    drawLayer.width = pictureLayer.width;
    drawLayer.height = pictureLayer.height;
    stickerLayer.width = pictureLayer.width;
    stickerLayer.height = pictureLayer.height;
    textLayer.width = pictureLayer.width;
    textLayer.height = pictureLayer.height;
    mouseLayer.width = pictureLayer.width;
    mouseLayer.height = pictureLayer.height;
    drawArea.style.height = pictureLayer.height + "px";
}
resizeCanvas();
init();

mouseLayer.addEventListener("mouseup", function(e) {


}, false);

file_browse.addEventListener("change", function(e) {
    if (this.files && this.files[0]) {
        var FR = new FileReader();

        FR.onload = function(e) {
            var img = new Image();
            img.src = e.target.result;
            var photo = new Photos(e.target.result, 50, 50, img.width, img.height, 0, -1);
            photos.push(photo);
            // photos.push(e.target.result);
            doSend(JSON.stringify(new Command("newPicture", JSON.stringify(photos))));
        };

        FR.readAsDataURL(this.files[0]);
    }

}, false);

function init() {
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) {};

    websocket.onclose = function(evt) {};

    websocket.onmessage = function(evt) {
        onMessage(evt)
    };

    websocket.onerror = function(evt) {};
}

function onMessage(evt) {

    try {
        var object = JSON.parse(evt.data);

        switch (object.name) {
            case "circle":
                var obj = JSON.parse(object.object);

                pictureContext.clearRect(0, 0, canvasWidth, canvasHeight);
                circles = new Array();
                for (var i = 0; i < obj.length; i++) {
                    var circle = new Circle(obj[i].initialX, obj[i].initialY, obj[i].radius);
                    circles.push(circle);
                    circle.update();
                }

                break;
            case "picture":
                //initialX, initialY, width, height, r, selected
                var obj = JSON.parse(object.object);
                for (var i = 0; i < obj.length; i++) {
                    photos[i].initialX = obj[i].initialX;
                    photos[i].initialY = obj[i].initialY;
                    photos[i].width = obj[i].width;
                    photos[i].height = obj[i].height;
                    photos[i].r = obj[i].r;
                    photos[i].selected = obj[i].selected;
                }

                draw();

                break;
            case "newPicture":
                var obj = JSON.parse(object.object);
                photos = [];
                for (var i = 0; i < obj.length; i++) {
                    photos.push(obj[i]);
                }

                drawNew();
                break;
            case "onlineNum":
            
                break;
        }
    } catch (e) {
        // do nothing
    }

}

function drawImg(src) {
    var img = new Image();
    img.onload = function() {
        pictureContext.drawImage(img, 0, 0);
    }
    img.src = src;
}

function onError(evt) {}

function doSend(message) {
    websocket.send(message);
}

function Command(name, object) {
    this.name = name;
    this.object = object;
}

Command.prototype.send = function() {
    ws.broadcast(JSON.stringify(this));
};
</script>
